<%-- 
    Document   : vulnerabilitylist
    Created on : May 27, 2016, 2:16:57 PM
    Author     : sathuluri
--%>
<%@taglib prefix="c" uri="/WEB-INF/tlds/c.tld" %>
<%@taglib uri="/WEB-INF/tlds/fn.tld" prefix="fn"%>
<%@taglib uri="http://jakarta.apache.org/taglibs/unstandard-1.0" prefix="un"%>
<un:useConstants className="com.optum.oss.constants.PermissionConstants" var="prmnsConstants" />
<un:useConstants className="com.optum.oss.constants.ApplicationConstants" var="appConstants" />
<script type="text/javascript" src="<c:url value="/js/jquery.simplePagination.js"/>"></script>
<link href="<c:url value="/css/simplePagination.css"/>" type="text/css" rel="stylesheet"/>

<script type="text/javascript">
    $(document).ready(function() {
        
        $('.fixme').fixheadertable({
            //colratio: [40, 120, , 130, 120, 130, 120, 120, 100, ],
            //colratio:[30,,,,,,,,,,],
            zebra: false,
            <c:if test="${vulnerabilityList[0].vulCount > 10}">
                height: 250,
            </c:if>
            whiteSpace: 'normal', resizeCol: false
        });
     });
     
     $("#searchVulnerabilities").click(function() {
        document.removeVulnerabilityForm.action = "reviewvulnerability.htm";
        document.removeVulnerabilityForm.submit();
    });

    jQuery(function($) {
        <c:if test="${fn:length(vulnerabilityList) > 0}">
          var numItems = ${vulnerabilityList[0].vulCount};
        </c:if>
        var perPage = ${searchVuln.rowCount};

        // now setup pagination
        $("#pagination").pagination({
            items: numItems,
            itemsOnPage: perPage,
            cssStyle: "light-theme",
            currentPage: ${pageNo},
            onPageClick: function(pageNumber) { // this is where the magic happens
                $("#pgcnt").val(pageNumber);
                document.removeVulnerabilityForm.action = "reviewvulnerability.htm";
                document.removeVulnerabilityForm.submit();

            }
        });
    });
</script>

<!--Start: panel-->
<div class="ux-panl ux-margin-top-1t">
    <form name="removeVulnerabilityForm" commandName="vulnerabilityDTOs" method="POST">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="cgenk"/>
        <input type="hidden" value="${engagementDTO.orgSchema}" name="orgSchma"/>
        <input type="hidden" value="1" name="pgcnt" id="pgcnt"/>
        <input type="hidden" value="${pageNo}" name="pgno"/>
        <div class="ux-panl-header ux-panl-with-underline">
            <h2 class="ux-float-left ux-width-full-3t-half ux-padding-halft">Finding List </h2>
            <div class="ux-float-right ux-padding-1t" style="font-size:12px;"> 
                <span class="ux-margin-right-1t"><strong>Total Records: </strong>${totalVulCount}</span>
                <span class="ux-margin-right-1t"><strong>Reviewed: </strong>${totalVulCount-vulNotReviewedCount}</span>
                <span class="ux-margin-right-1t"><strong>Not Reviewed: </strong>${vulNotReviewedCount}</span>
                <span class="ux-margin-right">Export To: 
                    <a href="#" title="Export To Excel" id="exportToExcel"><img src="images/excel.png"/></a> 
                </span>
            </div>
        </div>
        <!--Start: panel content-->
        <div class="ux-panl-content">
            <!-- Popup Starts -->
            <div id='blackcover2'> </div>
            <div id='popupbox2' class="ux-modl">
                <div class="ux-modl-header">
                    <a href="#" onclick='deletePopup(0)' title="Close">Close</a>
                    <h6>Notification</h6>
                </div>
                <div class="ux-modl-content">
                    <div align="center">
                        <h3>Are you sure you want to delete the finding(s)?</h3>
                    </div>
                    <div class="ux-margin-1t  " align="center">
                        <input type="button" title="OK" value="OK" class="ux-btn-default-action ux-width-7t" id="deleteVulnerability"/>
                        <input type="button" title="Cancel" value="Cancel" class="ux-btn-default-action ux-width-7t" onclick='deletePopup(0)'/> 
                    </div>
                </div>
            </div>
            <!-- Popup Ends -->
            
            <div class="ux-float-right ux-padding-bottom-min">
                <a href="#vul1" id="add1" title="Add">&nbsp;
                    <span class="SmallTxt VerticalAlignMiddle" id="addVulnerabilityDetails">+ Add</span>
                </a>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <a id="removeVulnerbility" type="button" href="#" title="Remove">&nbsp;
                    <span class="SmallTxt VerticalAlignMiddle">- Remove</span>
                </a>
            </div>
            <input type="hidden" value="${engagementDTO.encEngagementCode}" name="clientEngagementDTO.encEngagementCode" id="encEngagementCode"/>
            <div class="ux-clear"></div>
            <label id="errorCheckboxValidation" style="color: red" class="ux-float-left"></label>
            <input type="hidden" value="0" name="encInstanceIdentifier" id="encInstanceIdentifier"/>
            <table id="" class="fixme" >
                <thead>
                    <tr>
                        <th id="removeSortingForCheckbox"><input name="check" type="checkbox" id="headCheckbox" style="width: 26px !important;" onchange="checkAll(this)"/></th>
                        <th><strong>Finding ID</strong></th>
                        <th><strong>Finding Name</strong></th>
                        <th><strong>Service</strong></th>
                        <!--<th ><strong>Source</strong></th>-->
                        <th ><strong>Scan Tool</strong></th>
                        <th ><strong>IP Address</strong></th>
                        <th ><strong>Application Name</strong></th>
                        <th ><strong>Severity</strong></th>
                        <th ><strong>Status</strong></th>
                        <th ><strong>Action</strong></th>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="ux-padding-left-1t">
                            <input type="text" name="searchID" value="${searchVuln.searchID}"
                                   onkeypress="return numbersonly(this, event)" class="ux-width-6t" maxlength="10"/>
                        </td>
                        <td class="ux-padding-left-1t ">
                            <input type="text" name="vulnerabilityName" value="${searchVuln.vulnerabilityName}" class="ux-width-full-inclusive " onkeyup="limiter(this, 200, '', '')"/>
                        </td>
                        <td class="ux-padding-left-1t ">
                            <select id="securityServiceID" name="securityServiceObj.securityServiceCode" class="ux-width-full-inclusive">
                                <option value="">Select</option>
                                <c:forEach var="serviceDTO" items="${servicesList}">
                                    <c:if test="${serviceDTO.reviewStatus ne constants.DB_ROW_STATUS_REVIEWED}">
                                        <option value="${serviceDTO.securityServiceCode}" <c:if test="${serviceDTO.securityServiceCode eq searchVuln.securityServiceObj.securityServiceCode}">selected</c:if> >${serviceDTO.securityServiceName}</option>
                                    </c:if>
                                </c:forEach>
                            </select> 
                        </td>
                        <td class="ux-padding-left-1t ">
                            <select class="ux-width-full-inclusive" name="sourceCode" id="statusCodeID">     
                                <option value="0">Select</option>
                                <c:forEach var="sourceDTO" items="${scanToolList}">
                                    <option value="${sourceDTO.masterLookupKey}" <c:if test="${searchVuln.sourceCode eq sourceDTO.masterLookupKey}">selected</c:if> >${sourceDTO.lookUpEntityName}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td class="ux-padding-left-1t ">
                            <input type="text"  name="ipAddress" value="${searchVuln.ipAddress}" class="ux-width-full-inclusive"
                                   onkeyup="limiter(this, 35, '', '')"/>
                        </td>
                        <td class="ux-padding-left-1t">
                            <input type="text" name="softwareName" value="${searchVuln.softwareName}" class="ux-width-full-inclusive"/>
                        </td>
                        <td class="ux-padding-left-1t ">
                            <select class="ux-width-full-inclusive" name="cveInformationDTO.severityCode" id="statusCodeID">     
                                <option value="">Select</option>
                                <c:forEach var="severityDTO" items="${severityList}">
                                    <option value="${severityDTO.id}" <c:if test="${searchVuln.cveInformationDTO.severityCode eq severityDTO.id}">selected</c:if> >${severityDTO.name}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td class="ux-padding-left-1t ">
                            <select class="ux-width-full-inclusive" name="statusCode" id="statusCodeID">     
                                <option value="">Select</option>
                                <c:forEach var="statusDTO" items="${statusList}">
                                    <option value="${statusDTO.masterLookupCode}" <c:if test="${searchVuln.statusCode eq statusDTO.masterLookupCode}">selected</c:if> >${statusDTO.lookUpEntityName}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td  class="ux-padding-left-1t ux-padding-bottom-halft">
                            <a href="#" id="searchVulnerabilities">
                                <img src="images/search.png" title="Search"/>
                            </a>
                            <a href="javascript:void(0)" id="fnRefreshFindings"><img src="images/refresh.png" title="Refresh"/></a>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <c:set var="count" value="0"/>
                    <c:choose>
                        <c:when test="${fn:length(vulnerabilityList) > 0}">
                            <c:forEach var="vulnerabilityDTO" items="${vulnerabilityList}" begin="0" end="100" >
                                <tr <c:if test="${count %2 != 0}">style="background-color:#fbf9ba"</c:if> >
                                    <td><input type="checkbox" class="ux-width-2t checkboxGroup" onchange="singleCheckbox(this)"
                                               value="${vulnerabilityDTO.encInstanceIdentifier}" id="encIdentifier${count}" name="instanceIdentifier"/>
                                    </td>
                                      
                                    <td><c:choose>
                                            <c:when test="${permissions.contains(prmnsConstants.VIEW_VULNERABILITY)}">
                                                <a href="javascript:void(0)" onclick="viewVulnerability(${count})" title="${vulnerabilityDTO.instanceIdentifier}">
                                                    <c:out value="${vulnerabilityDTO.instanceIdentifier}" escapeXml="true"/>
                                                </a>
                                            </c:when>
                                            <c:otherwise>
                                                <c:out value="${vulnerabilityDTO.instanceIdentifier}" escapeXml="true"/>
                                            </c:otherwise>
                                        </c:choose>
                                    </td>
                                    <td><c:out value="${vulnerabilityDTO.vulnerabilityName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.securityServiceObj.securityServiceName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.scanTool}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.ipAddress}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.softwareName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.cveInformationDTO.severityName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.statusName}" escapeXml="true"/></td>
                                    <td>
                                        <c:if test="${vulnerabilityDTO.rowStatusValue eq 'Reviewed'}">
                                            <c:if test="${permissions.contains(prmnsConstants.VIEW_VULNERABILITY)}">
                                                <a href="#" title="View" id="editVulnerabilityID" class="ux-icon-view"
                                                   onclick="viewVulnerability(${count})"></a>
                                            </c:if>
                                        </c:if>
                                        <c:if test="${vulnerabilityDTO.rowStatusValue eq 'Not Reviewed'}">
                                            <c:choose>
                                                <c:when test="${vulnerabilityDTO.statusCode eq appConstants.DB_CONSTANT_FINDING_VALIDATE_STATUS_CODE ||
                                                        vulnerabilityDTO.statusCode eq appConstants.DB_CONSTANT_FINDING_OPEN_STATUS_CODE ||
                                                        vulnerabilityDTO.statusCode eq appConstants.DB_CONSTANT_FINDING_FALSE_POSITIVE_STATUS_CODE ||
                                                        vulnerabilityDTO.statusCode eq appConstants.DB_CONSTANT_FINDING_DUPLICATE_STATUS_CODE ||
                                                        vulnerabilityDTO.statusCode eq appConstants.DB_CONSTANT_FINDING_CLOSED_WITH_EXCEPTION_STATUS_CODE
                                                        }">
                                                    <a href="#" title="Edit" id="editVulnerabilityID" class="ux-icon-edit"
                                                        onclick="editVulnerability(${count})"></a>
                                                </c:when>
                                                <c:otherwise>
                                                    <a href="#" title="View" id="editVulnerabilityID" class="ux-icon-view"
                                                        onclick="viewVulnerability(${count})"></a>
                                                </c:otherwise>
                                            </c:choose>
                                        </c:if>
                                    </td>
                                </tr>
                                <c:set var="count" value="${count+1}"/>
                            </c:forEach>
                        </c:when>
                        <c:otherwise>
                            <td colspan="9">
                                <center>No matching records found</center>
                            </td>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>
            <div id="pagination"></div>
        </div>
        <!--End: panel content-->
    </form>
    <form action="" name="refreshFindingListForm" commandName="vulnerabilityDTOs" method="POST">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="cgenk"/>
        <input type="hidden" value="${engagementDTO.orgSchema}" name="orgSchma"/>
        <input type="hidden" value="1" name="pgcnt" id="pgcnt"/>
    </form>
</div>
<!--End: panel-->
