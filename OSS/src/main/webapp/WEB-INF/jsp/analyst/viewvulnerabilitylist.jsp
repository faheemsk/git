<%-- 
    Document   : viewvulnerabilitylist
    Created on : May 26, 2016, 5:23:15 PM
    Author     : vkosuri
--%>
<%@taglib prefix="c" uri="/WEB-INF/tlds/c.tld" %>
<%@taglib prefix="spring" uri="/WEB-INF/tlds/spring-form.tld"%>
<%@taglib uri="/WEB-INF/tlds/fn.tld" prefix="fn"%>
<%@taglib uri="http://jakarta.apache.org/taglibs/unstandard-1.0" prefix="un"%>
<un:useConstants className="com.optum.oss.constants.ApplicationConstants" var="constants"/>
<un:useConstants className="com.optum.oss.constants.PermissionConstants" var="prmnsConstants" />
<script type="text/javascript" src="<c:url value="/appjs/addreports.js"/>"></script>


<!-- content starts -->
<style>
    div.t_fixed_header.ui .headtable th {
        padding-left : 4px!important;
	padding : 13px;
	text-align : left;
	border-width : 0 0px 0 0;
	border-style : solid;
}
</style>
    <script>
        $(document).ready(function() {
            $("#seiaccordion").accordion({
                collapsible: true,
                heightStyle: "content"
            });
            $("#rsaccordion").accordion({
                collapsible: true,
                heightStyle: "content"
            });
            
            //Start: For Review Complete
            $("#reviewComplete").click(function() {
                document.viewVulnerabilityForm.action = "updateservicestatus.htm";
                document.viewVulnerabilityForm.submit();
            });
            //Start: For Review Complete
        });
        
    </script>
    <form name="toDashboardPageForm" action="#"  id="toDashboardPageForm" method="post">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="engKey" id="engKey"/>
        <input type="hidden" name="from" id="from"/> 
    </form>
        
    <!-- This form is used to redirect to Roadmap Page. Here we are passing encrypted engagement code. -->
    <form name="toRoadmapPage" id="toRoadmapPage" method="post" action="">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="clientEngagementDTO.encEngagementCode" id="clientEngagementDTO.encEngagementCode"/>
        <input type="hidden" value="${engagementDTO.orgSchema}" name="orgSchema" id="orgSchema"/>
    </form>
        
    <form action="" name="viewVulnerabilityForm" commandName="vulnerabilityDto" method="POST">
    <h1 class="ux-float-left ux-width-full-4t ux-margin-top-1t">View Finding List </h1> <span class="ux-float-right ux-padding-1t">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="clientEngagementDTO.encEngagementCode" id="encEngagementCode"/>
        <!--Bug Id: IN:021289: services drop down and review complete button shows when user have Review Vulnerability permission-->
        <c:if test="${permissions.contains(prmnsConstants.REVIEW_VULNERABILITY)}">
            <select class="multiselect ux-margin-top-min ux-width-15t" multiple="multiple" name="securityServiceObj.securityServiceCode">
                <c:forEach var="serviceDTO" items="${servicesList}">
                    <c:choose>
                        <c:when test="${serviceDTO.reviewStatus eq constants.DB_ROW_STATUS_REVIEWED}">
                            <option value="${serviceDTO.securityServiceCode}" selected="true">${serviceDTO.securityServiceName}</option>
                        </c:when>
                        <c:otherwise>
                            <option value="${serviceDTO.securityServiceCode}">${serviceDTO.securityServiceName}</option>
                        </c:otherwise>
                    </c:choose>
                </c:forEach>
            </select>
            <input type="button" value="Review Complete" title="Review Complete" class="ux-btn-default-action" id="reviewComplete" onclick="window.location.href = ''" />
        </c:if>
            
        <c:if test="${permissions!=null && (permissions.contains(prmnsConstants.ADD_USER_TO_SERVICE)||permissions.contains(prmnsConstants.EDIT_USER_TO_SERVICE))}">
            <input type="button" value="Roadmap" title="Roadmap" class="ux-btn-default-action" onclick="toRoadmap()"/>
        </c:if>
        
        <!--Bug Id: IN:021289: services dropdown and review complete button shows when user have Review Vulnerability permission-->
        <c:if test="${clientreportspermission!=null && clientreportspermission.contains(prmnsConstants.VIEW_DASHBOARD)}">
        <input type="button" value="View Dashboard" title="View Dashboard" class="ux-btn-default-action" onclick="javascript:toDashboardPage('${constants.TO_VIEW_VULNERABILITES_LISTPAGE}')"></input>
    </c:if>
        <input type="button" value="Back" title="Back" class="ux-btn-default-action " onclick="headerFn('analystvalidationworklist.htm')" />
    </span>
    </form>
    <div class="ux-clear"></div>
    <div id="seiaccordion" class="ux-margin-top-2t" >
        <!--        <div class="ux-accordion-panl-header ux-panl-with-underline" >
                    <h2><a class="menuitem submenuheader " href="#" > Service Engagement Information</a></h2>
                </div>-->
        <h3> Service Engagement Information</h3>
        <div class="ux-accordion-panl">
            <div class="ux-hform">
                <dl>
                    <dt>
                    <label>Client Name:</label>
                    </dt>
                    <dd><c:out value="${engagementDTO.clientName}" escapeXml="true"></c:out></dd>
                    </dl>
                    <dl>
                        <dt>
                        <label>Engagement Code: </label>
                        </dt>
                        <dd><c:out value="${engagementDTO.engagementCode}" escapeXml="true"></c:out></dd>
                    </dl>
                    <dl>
                        <dt>
                        <label>Engagement Name:</label>
                        </dt>
                        <dd><c:out value="${engagementDTO.engagementName}" escapeXml="true"></c:out></dd>
                    </dl>
                    <dl>
                        <dt>
                        <label>Product:</label>
                        </dt>
                        <dd><c:out value="${engagementDTO.securityPackageObj.securityPackageName}" escapeXml="true"></c:out></dd>
                    </dl>
                    <dl>
                        <dt>
                        <label>Agreement Date: </label>
                        </dt>
                        <dd><c:out value="${engagementDTO.agreementDate}" escapeXml="true"></c:out></dd>
                </dl>
            </div>
        </div>
        <h3> Review Status</h3>
        <div class="ux-accordion-panl">
            <div id="reviewlist">
                <table class="ux-tabl-data">
                    <thead>
                        <tr>
                            <th>User Name</th>
                            <th>Service</th>
                            <th>Review Completed on</th>
                            <!--                                <th>Review Comments</th>-->
                        </tr>
                    </thead>
                    <tbody>
                    <c:forEach var="servicesDTO" items="${servicesList}">
                        <tr>
                            <td>${servicesDTO.createdByUser}</td>
                            <td>${servicesDTO.securityServiceName}</td>
                            <td>${servicesDTO.createdDate}</td>
                            <!--                                <td>Comments</td>-->
                        </tr>
                    </c:forEach>
                    </tbody>	
                </table>
            </div>
        </div>            
    </div>
    
    <div class="ux-clear"></div>
    <!--Start: Findings List-->
    <script type="text/javascript" src="<c:url value="/js/jquery.simplePagination.js"/>"></script>
<link href="<c:url value="/css/simplePagination.css"/>" type="text/css" rel="stylesheet"/>

<script type="text/javascript">
    $(document).ready(function() {
        
        $("#searchVulnerabilities").click(function() {
            document.removeVulnerabilityForm.action = "viewvulnerability.htm";
            document.removeVulnerabilityForm.submit();
        });
        
        //Start: For export excel
        $("#exportToExcel").click(function() {
            var flag = false;
            var checkboxes = new Array();
            $('.checkboxGroup').each(function() {
                if (this.checked) {
                    var id = $(this).attr('id');
                    checkboxes.push(id);
                    flag = true;
                    $("#errorCheckboxValidationForView").html("");
                }
            });
            if (!flag) {
                $("#errorCheckboxValidationForView").html("<font class='ux-msg-error-under' style='margin-top: -10px;' color='red'>Please select at least one Finding</font>");
                return false;
            } else {
                document.removeVulnerabilityForm.action = "vulnerabilityexporttoexcel.htm";
                document.removeVulnerabilityForm.submit();
            }
        });
        //End: For export excel

     });
     
     function viewVulnerability(vk) {
        var encInstanceIdentifier = $("#encIdentifier" + vk).val();
        $("#encInstanceIdentifier").val(encInstanceIdentifier);
        document.removeVulnerabilityForm.action = "viewvulnerabilitydetails.htm";
        document.removeVulnerabilityForm.submit();
    }

    jQuery(function($) {
        <c:if test="${fn:length(vulnerabilityList) > 0}">
            var numItems = ${vulnerabilityList[0].vulCount};
        </c:if>
        var perPage = ${searchVuln.rowCount};

        // now setup pagination
        $("#pagination").pagination({
            items: numItems,
            itemsOnPage: perPage,
            cssStyle: "light-theme",
            currentPage: ${pageNo},
            onPageClick: function(pageNumber) { // this is where the magic happens
                $("#pgcnt").val(pageNumber);
                document.removeVulnerabilityForm.action = "viewvulnerability.htm";
                document.removeVulnerabilityForm.submit();

            }
        });
    });
</script>

<!--Start: panel-->
<div class="ux-panl ux-margin-top-1t">
    <form action="" name="removeVulnerabilityForm" commandName="vulnerabilityDTOs" method="POST">
        <input type="hidden" value="0" name="encInstanceIdentifier" id="encInstanceIdentifier"/>
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="cgenk"/>
        <input type="hidden" value="${engagementDTO.orgSchema}" name="orgSchma" id="orgSchma"/>
        <input type="hidden" value="1" name="pgcnt" id="pgcnt"/>
        <input type="hidden" value="${pageNo}" name="pgno"/>
        <div class="ux-panl-header ux-panl-with-underline">
            <h2 class="ux-float-left ux-width-full-3t-half ux-padding-halft">Finding List </h2>
            <div class="ux-float-right ux-padding-1t" style="font-size:12px;">
<!--                 <span class="ux-margin-right-1t"><strong>Total Records: </strong>${totalVulCount}</span>
                <span class="ux-margin-right-1t"><strong>Total Validated: </strong>${vulValidatedCount}</span>
                <span class="ux-margin-right-1t"><strong>Not Validated: </strong>${totalVulCount-vulValidatedCount}</span>-->
                <span class="ux-margin-right">Export To: 
                    <a href="#" title="Export To Excel" id="exportToExcel"><img src="images/excel.png"/></a> 
                </span>
            </div>
        </div>
        <!--Start: panel content-->
        <div class="ux-panl-content">
            <input type="hidden" value="${engagementDTO.encEngagementCode}" name="clientEngagementDTO.encEngagementCode" id="encEngagementCode"/>
            <div class="ux-clear"></div>
            <label id="errorCheckboxValidationForView" style="color: red" class="ux-float-left"></label>
            <input type="hidden" value="0" name="encInstanceIdentifier" id="encInstanceIdentifier"/>
            <table id="" class="fixme">
                <thead>
                    <tr>
                        <th id="removeSortingForCheckbox" ><input name="check" type="checkbox" id="headCheckbox" style="width: 26px !important;"  onchange="checkAll(this)"/></th>
                        <th><strong>Finding ID</strong></th>
                        <th><strong>Finding Name</strong></th>
                        <th><strong>Service</strong></th>
                        <th ><strong>Source</strong></th>
                        <th ><strong>IP Address</strong></th>
                        <th ><strong>Application Name</strong></th>
                        <th ><strong>Severity</strong></th>
                        <th ><strong>Status</strong></th>
                        <th><strong>Action</strong></th>
                    </tr>
                    <tr>
                         <td></td>
                        <td class="ux-padding-left-min ">
                            <input type="text" name="searchID" value="${searchVuln.searchID}"
                                   onkeypress="return numbersonly(this, event)" class="ux-width-5t" maxlength="10"/>
                        </td>
                        <td class="ux-padding-left-min ">
                            <input type="text" name="vulnerabilityName" value="${searchVuln.vulnerabilityName}" class="ux-width-full-inclusive" onkeyup="limiter(this, 200, '', '')"/>
                        </td>
                        <td class="ux-padding-left-min ">
                            <select id="securityServiceID" name="securityServiceObj.securityServiceCode" class="ux-width-full-inclusive">
                                <option value="">Select</option>
                                <c:forEach var="serviceDTO" items="${servicesList}">
                                    <option value="${serviceDTO.securityServiceCode}" <c:if test="${serviceDTO.securityServiceCode eq searchVuln.securityServiceObj.securityServiceCode}">selected</c:if> >${serviceDTO.securityServiceName}</option>
                                </c:forEach>
                            </select> 
                        </td>
                        <td class="ux-padding-left-min ">
                            <select class="ux-width-full-inclusive" name="sourceCode" id="statusCodeID">     
                                <option value="0">Select</option>
                                <c:forEach var="sourceDTO" items="${sourceList}">
                                    <option value="${sourceDTO.masterLookupKey}" <c:if test="${searchVuln.sourceCode eq sourceDTO.masterLookupKey}">selected</c:if> >${sourceDTO.lookUpEntityName}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td class="ux-padding-left-min">
                            <input type="text"  name="ipAddress" value="${searchVuln.ipAddress}" class="ux-width-full-inclusive"
                                   onkeyup="limiter(this, 35, '', '')"/>
                        </td>
                        <td class="ux-padding-left-min ">
                            <input type="text" name="softwareName" value="${searchVuln.softwareName}" class="ux-width-full-inclusive"/>
                        </td>
                        <td class="ux-padding-left-min">
                            <select class="ux-width-full-inclusive" name="cveInformationDTO.severityCode" id="statusCodeID">     
                                <option value="">Select</option>
                                <c:forEach var="severityDTO" items="${severityList}">
                                    <option value="${severityDTO.id}" <c:if test="${searchVuln.cveInformationDTO.severityCode eq severityDTO.id}">selected</c:if> >${severityDTO.name}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td class="ux-padding-left-min ">
                            <select class="ux-width-full-inclusive" name="statusCode" id="statusCodeID">     
                                <option value="">Select</option>
                                <c:forEach var="statusDTO" items="${statusList}">
                                    <option value="${statusDTO.masterLookupCode}" <c:if test="${searchVuln.statusCode eq statusDTO.masterLookupCode}">selected</c:if> >${statusDTO.lookUpEntityName}</option>
                                </c:forEach>
                            </select>
                        </td>
                        <td class="ux-padding-left-min ux-padding-bottom-halft">
                            <a href="#" id="searchVulnerabilities">
                                <img src="images/search.png" title="Search"/>
                            </a>
                            <a href="javascript:void(0)" id="fnRefreshFindingsForView"><img src="images/refresh.png" title="Refresh"/></a>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <c:set var="count" value="0"/>
                    <c:choose>
                        <c:when test="${fn:length(vulnerabilityList) > 0}">
                            <c:forEach var="vulnerabilityDTO" items="${vulnerabilityList}" begin="0" end="100" >
                                <tr <c:if test="${count %2 != 0}">style="background-color:#fbf9ba"</c:if> > 
                                    <td><input type="checkbox" class="ux-width-2t checkboxGroup" onchange="singleCheckbox(this)"
                                               value="${vulnerabilityDTO.encInstanceIdentifier}" id="encIdentifier${count}" name="instanceIdentifier"/></td>
                                    <td>
                                        <c:choose>
                                            <c:when test="${permissions.contains(prmnsConstants.VIEW_VULNERABILITY)}">
                                                <a href="javascript:void(0)" onclick="viewVulnerability(${count})" title="${vulnerabilityDTO.instanceIdentifier}">
                                                    <c:out value="${vulnerabilityDTO.instanceIdentifier}" escapeXml="true"/>
                                                </a>
                                            </c:when>
                                            <c:otherwise>
                                                <c:out value="${vulnerabilityDTO.instanceIdentifier}" escapeXml="true"/>
                                            </c:otherwise>
                                        </c:choose>
                                    </td>
                                    <td><c:out value="${vulnerabilityDTO.vulnerabilityName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.securityServiceObj.securityServiceName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.sourceName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.ipAddress}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.softwareName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.cveInformationDTO.severityName}" escapeXml="true"/></td>
                                    <td><c:out value="${vulnerabilityDTO.statusName}" escapeXml="true"/></td>
                                    <td>
                                        <c:if test="${vulnerabilityDTO.rowStatusValue eq 'Reviewed'}">
                                            <c:if test="${permissions.contains(prmnsConstants.VIEW_VULNERABILITY)}">
                                                <a href="#" title="View" id="editVulnerabilityID" class="ux-icon-view"
                                                   onclick="viewVulnerability(${count})"></a>
                                            </c:if>
                                        </c:if>
                                        <c:if test="${vulnerabilityDTO.rowStatusValue eq 'Not Reviewed'}">
                                            <a href="#" title="Edit" id="editVulnerabilityID" class="ux-icon-edit"
                                               onclick="editVulnerability(${count})"></a>
                                        </c:if>
                                    </td>
                                </tr>
                                <c:set var="count" value="${count+1}"/>
                            </c:forEach>
                        </c:when>
                        <c:otherwise>
                            <td colspan="10">
                                <center>No matching records found</center>
                            </td>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>
            <div id="pagination"></div>
        </div>
        <!--End: Findings list-->
    </form>
    <form action="" name="refreshFindingListForm" commandName="vulnerabilityDTOs" method="POST">
        <input type="hidden" value="${engagementDTO.encEngagementCode}" name="cgenk"/>
        <input type="hidden" value="1" name="pgcnt" id="pgcnt"/>
        <input type="hidden" value="${engagementDTO.orgSchema}" name="orgSchma" id="orgSchma"/>
    </form>
                    
    <div id="showaddvul1">
        <c:if test="${viewPageName eq 'VIEWPAGE'}">
            <jsp:include page="../analyst/viewvulnerabilitydetails.jsp"/>
        </c:if>
    </div>
</div>
<!--End: panel-->
