CREATE PROCEDURE [dbo].[Analyst_ListVulnerability]
(
       
       @CLNT_ENGMT_CD             VARCHAR(30),
       @PageNo                    INTEGER,
       @RowspPage                          INTEGER,
       @CLNT_VULN_INSTC_KEY         INTEGER,
       @VULN_NM                   VARCHAR(255),
       @SECUR_SRVC_CD             VARCHAR(10),
       @VULN_SRC                  INTEGER,
       @IPADR                              VARCHAR(39),
       @VULN_SEV_CD                        VARCHAR(3),
       @STSKEY                    VARCHAR(3),
       @SFTW_NM                   VARCHAR(150),
          @schema                                 VARCHAR(50)  
)
AS
BEGIN

DECLARE @Count INTEGER

BEGIN TRY
SET NOCOUNT ON
DECLARE @Query VARCHAR(max)
DECLARE @Query1 VARCHAR(max)
DECLARE @Query2 VARCHAR(max)

                BEGIN TRAN

                     SET   @Query = 'SELECT              COUNT(A.CLNT_ENGMT_CD) TotalCount
                     FROM            '+ @schema+'.CLNT_VULN_INSTC   A             
                     WHERE           A.ROW_STS_KEY              =   1
                     AND           A.CLNT_ENGMT_CD                   =   ''' + CONVERT(VARCHAR,@CLNT_ENGMT_CD) +'''
                     AND           CLNT_VULN_INSTC_KEY =                   CASE WHEN ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''= 0  THEN       CLNT_VULN_INSTC_KEY ELSE  ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''  END
                     AND           ISNULL(A.VULN_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@VULN_NM) +'''= ''''               THEN       ISNULL(A.VULN_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@VULN_NM) +'%' +''' END      
                     AND           ISNULL(A.SECUR_SRVC_CD,'''') =          CASE WHEN ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +''' = ''''    THEN       ISNULL(A.SECUR_SRVC_CD,'''') ELSE ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +'''  END   
                     AND           ISNULL(A.VULN_SRC_KEY,0)   =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SRC) +'''= 0                 THEN       ISNULL(A.VULN_SRC_KEY,0) ELSE ''' + CONVERT(VARCHAR,@VULN_SRC) +''' END     
                     AND           ISNULL(A.IPADR,'''') LIKE               CASE WHEN ''' + CONVERT(VARCHAR,@IPADR) +''' = ''''                THEN       ISNULL(A.IPADR,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@IPADR) +'%' +''' END
                     AND           ISNULL(A.VULN_SEV_CD,'''') =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +''' = ''''          THEN       ISNULL(A.VULN_SEV_CD,'''') ELSE ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +'''  END
                     AND           ISNULL(A.VULN_INSTC_STS_CD,'''') = CASE WHEN ''' + CONVERT(VARCHAR,@STSKEY) +'''= ''''                THEN       ISNULL(A.VULN_INSTC_STS_CD,'''') ELSE ''' + CONVERT(VARCHAR,@STSKEY) +'''  END
                     AND           ISNULL(A.SFTW_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@SFTW_NM) +'''= ''''               THEN       ISNULL(A.SFTW_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@SFTW_NM) +'%' +''' END

                     GROUP BY A.CLNT_ENGMT_CD'
                           
                                  -- print @Query
                                    EXECUTE (@Query)

					 SET   @Query2 = 'SELECT              COUNT(A.CLNT_VULN_INSTC_KEY) OpenCount
                     FROM            '+ @schema+'.CLNT_VULN_INSTC   A             
                     WHERE           A.ROW_STS_KEY              =   1
                     AND           A.CLNT_ENGMT_CD                   =   ''' + CONVERT(VARCHAR,@CLNT_ENGMT_CD) +'''
                     AND           CLNT_VULN_INSTC_KEY =                   CASE WHEN ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''= 0  THEN       CLNT_VULN_INSTC_KEY ELSE  ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''  END
                     AND           ISNULL(A.VULN_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@VULN_NM) +'''= ''''               THEN       ISNULL(A.VULN_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@VULN_NM) +'%' +''' END      
                     AND           ISNULL(A.SECUR_SRVC_CD,'''') =          CASE WHEN ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +''' = ''''    THEN       ISNULL(A.SECUR_SRVC_CD,'''') ELSE ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +'''  END   
                     AND           ISNULL(A.VULN_SRC_KEY,0)   =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SRC) +'''= 0                 THEN       ISNULL(A.VULN_SRC_KEY,0) ELSE ''' + CONVERT(VARCHAR,@VULN_SRC) +''' END     
                     AND           ISNULL(A.IPADR,'''') LIKE               CASE WHEN ''' + CONVERT(VARCHAR,@IPADR) +''' = ''''                THEN       ISNULL(A.IPADR,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@IPADR) +'%' +''' END
                     AND           ISNULL(A.VULN_SEV_CD,'''') =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +''' = ''''          THEN       ISNULL(A.VULN_SEV_CD,'''') ELSE ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +'''  END
                     AND           ISNULL(A.VULN_INSTC_STS_CD,'''') = CASE WHEN ''' + CONVERT(VARCHAR,@STSKEY) +'''= ''''                THEN       ISNULL(A.VULN_INSTC_STS_CD,'''') ELSE ''' + CONVERT(VARCHAR,@STSKEY) +'''  END
                     AND           ISNULL(A.SFTW_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@SFTW_NM) +'''= ''''               THEN       ISNULL(A.SFTW_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@SFTW_NM) +'%' +''' END
					 AND		   A.VULN_INSTC_STS_CD =''O''
                     GROUP BY A.CLNT_ENGMT_CD'
                           
                                  -- print @Query
                                    EXECUTE (@Query2)

                     SET   @Query1 = 'SELECT             CLNT_VULN_INSTC_KEY,A.VULN_NM,A.VULN_SRC_KEY,B.LKP_ENTY_NM VULN_SRC,A.VULN_SEV_CD,G.VULN_SEV_NM,A.IPADR,
                                   C.VULN_INSTC_STS_CD,C.VULN_INSTC_STS_NM,D.SECUR_SRVC_NM,A.SECUR_SRVC_CD,F.LKP_ENTY_NM [Service Status],
                                   A.CREAT_DT,A.UPDT_DT,A.SFTW_NM
                     FROM            '+ @schema+'.CLNT_VULN_INSTC             A
                     JOIN            MSTR_LKP                                 B
                     ON            A.VULN_SRC_KEY                    =      B.MSTR_LKP_KEY
                     JOIN            VULN_INSTC_STS                           C
                     ON            C.VULN_INSTC_STS_CD        =   A.VULN_INSTC_STS_CD
                     JOIN            SECUR_SRVC                               D
                     ON            D.SECUR_SRVC_CD                   =   A.SECUR_SRVC_CD
                     JOIN            CLNT_SECUR_SRVC_ENGMT             E
                     ON            E.SECUR_SRVC_CD                   =      A.SECUR_SRVC_CD      
                     JOIN            MSTR_LKP                                 F
                     ON            E.SRVC_ENGMT_STS_KEY =   F.MSTR_LKP_KEY
                     AND           A.CLNT_ENGMT_CD                   =   E.CLNT_ENGMT_CD
                     LEFT JOIN     VULN_SEV                          G
                     ON            G.VULN_SEV_CD              =   A.VULN_SEV_CD          
                     WHERE           A.ROW_STS_KEY              =   1
                     AND           A.CLNT_ENGMT_CD                   =   ''' + CONVERT(VARCHAR,@CLNT_ENGMT_CD) +'''
                     AND           CLNT_VULN_INSTC_KEY =                   CASE WHEN ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''= 0  THEN       CLNT_VULN_INSTC_KEY ELSE  ''' + CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +'''  END
                     AND           ISNULL(A.VULN_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@VULN_NM) +'''= ''''               THEN       ISNULL(A.VULN_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@VULN_NM) +'%' +''' END      
                     AND           ISNULL(A.SECUR_SRVC_CD,'''') =          CASE WHEN ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +''' = ''''    THEN       ISNULL(A.SECUR_SRVC_CD,'''') ELSE ''' + CONVERT(VARCHAR,@SECUR_SRVC_CD) +'''  END   
                     AND           ISNULL(A.VULN_SRC_KEY,0)   =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SRC) +'''= 0                 THEN       ISNULL(A.VULN_SRC_KEY,0) ELSE ''' + CONVERT(VARCHAR,@VULN_SRC) +''' END     
                     AND           ISNULL(A.IPADR,'''') LIKE               CASE WHEN ''' + CONVERT(VARCHAR,@IPADR) +''' = ''''                THEN       ISNULL(A.IPADR,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@IPADR) +'%' +''' END
                     AND           ISNULL(A.VULN_SEV_CD,'''') =            CASE WHEN ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +''' = ''''          THEN       ISNULL(A.VULN_SEV_CD,'''') ELSE ''' + CONVERT(VARCHAR,@VULN_SEV_CD) +'''  END
                     AND           ISNULL(A.VULN_INSTC_STS_CD,'''') = CASE WHEN ''' + CONVERT(VARCHAR,@STSKEY) +'''= ''''                THEN       ISNULL(A.VULN_INSTC_STS_CD,'''') ELSE ''' + CONVERT(VARCHAR,@STSKEY) +'''  END
                     AND           ISNULL(A.SFTW_NM,'''') LIKE             CASE WHEN ''' + CONVERT(VARCHAR,@SFTW_NM) +'''= ''''               THEN       ISNULL(A.SFTW_NM,'''') ELSE ''' + '%' + CONVERT(VARCHAR,@SFTW_NM) +'%' +''' END

                     ORDER BY   CLNT_VULN_INSTC_KEY ASC
                     OFFSET ((' +CONVERT(VARCHAR,@PageNo) +' - 1) * ' + CONVERT(VARCHAR,@RowspPage)+') ROWS
                     FETCH NEXT '+CONVERT(VARCHAR,@RowspPage)+' ROWS ONLY;'
               EXECUTE (@Query1)       
              
END TRY

BEGIN CATCH

    DECLARE @ErrorNumber INT = ERROR_NUMBER();
    DECLARE @ErrorLine INT = ERROR_LINE();
    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE();
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY();
    DECLARE @ErrorState INT = ERROR_STATE();

    PRINT 'Actual error number: ' + CAST(@ErrorNumber AS VARCHAR(10));
    PRINT 'Actual line number: ' + CAST(@ErrorLine AS VARCHAR(10));

    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
  END CATCH
COMMIT TRANSACTION
END



