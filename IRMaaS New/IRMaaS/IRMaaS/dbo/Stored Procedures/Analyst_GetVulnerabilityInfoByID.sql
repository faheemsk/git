CREATE PROCEDURE [dbo].[Analyst_GetVulnerabilityInfoByID]
(
	@CLNT_VULN_INSTC_KEY INTEGER,
	@schema				 VARCHAR(50)
)
AS
BEGIN


BEGIN TRY
SET NOCOUNT ON

DECLARE @Query VARCHAR(max)

			SET		@Query ='SELECT CLNT_VULN_INSTC_KEY,VULN_NM,CONVERT(VARCHAR,CREAT_DT,101)CREAT_DT,VULN_DESC,VULN_TECH_COMMT_TXT,
					VULN_IMP_COMMT_TXT,RECOM_COMMT_TXT,ROOT_CAUS_COMMT_TXT,VULN_CATGY_CD,
					VULN_INSTC_STS_CD,VULN_INSTC_STS_NM,CVE_ID,CVE_DESC,LST_MOD_DT,CWE_ID,
					VULN_BAS_SCOR,VULN_TMPRL_SCOR,VULN_ENV_SCOR,VULN_VCTR_TXT,
					VULN_SEV_NM,RISK_PRBL_NM,VULN_IMP_NM,RMDTN_CST_EFFRT_NM,SECUR_CTL_FAM_NM,SECUR_OBJ_NM,SECUR_CTL_NM,
					OWASP_TOP_10_KEY,OWASP_CD,OWASP_NM 
			FROM	'+ @schema+'.Findings
			WHERE	CLNT_VULN_INSTC_KEY	=   '+CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY)
			EXECUTE (@Query)

END TRY

BEGIN CATCH

    DECLARE @ErrorNumber INT = ERROR_NUMBER();
    DECLARE @ErrorLine INT = ERROR_LINE();
    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE();
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY();
    DECLARE @ErrorState INT = ERROR_STATE();

    PRINT 'Actual error number: ' + CAST(@ErrorNumber AS VARCHAR(10));
    PRINT 'Actual line number: ' + CAST(@ErrorLine AS VARCHAR(10));

    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
  END CATCH
-- COMMIT TRANSACTION
END


