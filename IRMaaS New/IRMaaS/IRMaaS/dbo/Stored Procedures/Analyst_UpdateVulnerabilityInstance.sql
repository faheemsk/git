CREATE PROCEDURE [dbo].[Analyst_UpdateVulnerabilityInstance]
(
       @Flag                             VARCHAR(1),
       @SECUR_SRVC_CD                    VARCHAR(10),
       @IPADR                            VARCHAR(39),
       @SFTW_NM                          VARCHAR(150),
       @HST_NM                                  VARCHAR(150),
       @DOM_NM                                  VARCHAR(150),
       @APPL_URL                         NVARCHAR(2000),
       @OS_KEY                                  INTEGER,
       @MAC_ADR_NM                       VARCHAR(150),
       @PORT_NBR                         INTEGER,
       @CLNT_VULN_INSTC_KEY INTEGER,
       @VULN_INSTC_STS_CD         VARCHAR(3),
       @VULN_SEV_CD               VARCHAR(3),
       @VULN_IMP_CD               VARCHAR(3),
       @RISK_PRBL_CD              VARCHAR(3),
       @RMDTN_CST_EFFRT_CD        VARCHAR(3),
       @VULN_CATGY_CD        VARCHAR(10),
       @CVE_ID                                  VARCHAR(25),
       @VULN_NM                          VARCHAR(255),
       @VULN_DESC                        TEXT,
       @SRC_ADVS_TXT              VARCHAR(1024),
       @VULN_BAS_SCOR                    DECIMAL(10,2),
       @VULN_IMP_SUB_SCOR         DECIMAL(10,2),
       @VULN_EXPLT_SUB_SCOR              DECIMAL(10,2),
       @VULN_TMPRL_SCOR           DECIMAL(10,2),
       @VULN_ENV_SCOR                    DECIMAL(10,2),
       @VULN_VCTR_TXT                    VARCHAR(100),
       @VULN_TECH_COMMT_TXT              TEXT,
       @VULN_IMP_COMMT_TXT        TEXT,
       @RECOM_COMMT_TXT           TEXT,
       @ROOT_CAUS_COMMT_TXT    TEXT,
       @USER_ID                          INTEGER,
       @VULN_OVALL_SCOR           DECIMAL(10,2),
       @OWASP_TOP_10_KEY          INTEGER,
       @schema                                  VARCHAR(50)   

)
AS
BEGIN


BEGIN TRY
SET NOCOUNT ON
DECLARE @Query VARCHAR(max)
       
              IF @Flag      =      'E' -- ETL
                       
              BEGIN

              SET           @Query = 'UPDATE     '+ @schema+'.CLNT_VULN_INSTC
              
              SET           VULN_INSTC_STS_CD    =      ''' +CONVERT(VARCHAR,@VULN_INSTC_STS_CD)+''' ,
                           VULN_SEV_CD                =      '+ isnull('''' + convert(varchar(50),@VULN_SEV_CD) + '''','null') + ',
                           VULN_IMP_CD                =      '+ isnull('''' + convert(varchar(50),@VULN_IMP_CD) + '''','null') + ',
                           RISK_PRBL_CD         =      '+ isnull('''' + convert(varchar(50),@RISK_PRBL_CD) + '''','null') + ',
                           RMDTN_CST_EFFRT_CD   =      '+ isnull('''' + convert(varchar(50),@RMDTN_CST_EFFRT_CD) + '''','null') + ',
                           VULN_CATGY_CD   =      '+ isnull('''' + convert(varchar(50),@VULN_CATGY_CD) + '''','null') + ',
                           CVE_ID                     =      '+ isnull('''' + convert(varchar(25),@CVE_ID) + '''','null') + ',
                           VULN_NM                           =      '+ isnull('''' + replace(convert(varchar(255),@VULN_NM),'''','''''') + '''','null') + ',
                           VULN_DESC                  =      '+ isnull('''' + replace(convert(varchar(max),@VULN_DESC),'''','''''') + '''','null') + ',
                           SRC_ADVS_TXT         =      '+ isnull('''' + convert(varchar(max),@SRC_ADVS_TXT) + '''','null') + ',
                           VULN_BAS_SCOR        =      '+ isnull('''' + convert(varchar(50),@VULN_BAS_SCOR) + '''','null') + ',
                           VULN_IMP_SUB_SCOR    =      '+ isnull('''' + convert(varchar(50),@VULN_IMP_SUB_SCOR) + '''','null') + ',
                           VULN_EXPLT_SUB_SCOR =   '+ isnull('''' + convert(varchar(50),@VULN_EXPLT_SUB_SCOR) + '''','null') + ',
                           VULN_TMPRL_SCOR            =      '+ isnull('''' + convert(varchar(50),@VULN_TMPRL_SCOR) + '''','null') + ',
                           VULN_ENV_SCOR        =      '+ isnull('''' + convert(varchar(50),@VULN_ENV_SCOR) + '''','null') + ',
                           VULN_VCTR_TXT        =      '+ isnull('''' + convert(varchar(max),@VULN_VCTR_TXT) + '''','null') + ',
                           VULN_TECH_COMMT_TXT =   '+ isnull('''' + replace(convert(varchar(max),@VULN_TECH_COMMT_TXT),'''','''''') + '''','null') + ',
                           VULN_IMP_COMMT_TXT   =      '+ isnull('''' + replace(convert(varchar(max),@VULN_IMP_COMMT_TXT),'''','''''') + '''','null') + ',
                           RECOM_COMMT_TXT            =      '+ isnull('''' +replace(convert(varchar(max),@RECOM_COMMT_TXT),'''','''''') + '''','null') + ',
                           ROOT_CAUS_COMMT_TXT =      '+ isnull('''' + replace(convert(varchar(max),@ROOT_CAUS_COMMT_TXT),'''','''''') + '''','null') + ',   
                           UPDT_DT                           =      '+' GETDATE() '+',
                           UPDT_USER_ID         =      '+convert(varchar(50),@USER_ID)+ ',
                           VULN_OVALL_SCOR            =      '+ isnull('''' + convert(varchar(50),@VULN_OVALL_SCOR) + '''','null') + ',
                           OWASP_TOP_10_KEY     =      '+ isnull('''' + convert(varchar(50),@OWASP_TOP_10_KEY) + '''','null') + '

                           WHERE  CLNT_VULN_INSTC_KEY  =      '+ CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +''

                           EXECUTE (@Query)
                           SELECT @@ROWCOUNT AS RETVAL

                     END

              IF @Flag    =      'M' -- Manual Entry
                       
              BEGIN

              SET         @Query = 'UPDATE     '+ @schema+'.CLNT_VULN_INSTC

              SET         SECUR_SRVC_CD                       =      ''' +CONVERT(VARCHAR,@SECUR_SRVC_CD)+''',         
                          IPADR                     =     '+ isnull('''' + convert(varchar(50),@IPADR) + '''','null') + ',                         
                          SFTW_NM                   =      '+ isnull('''' + convert(varchar(150),@SFTW_NM) + '''','null') + ',                      
                          HST_NM                    =     '+ isnull('''' + convert(varchar(150),@HST_NM) + '''','null') + ',                      
                          DOM_NM                    =     '+ isnull('''' + convert(varchar(150),@DOM_NM) + '''','null') + ',                            
                          APPL_URL                  =     '+ isnull('''' + convert(varchar(2000),@APPL_URL) + '''','null') + ',                  
                          OS_KEY                    =     '+ isnull('''' + convert(varchar(50),@OS_KEY) + '''','null') + ',                              
                          MAC_ADR_NM                =     '+ isnull('''' + convert(varchar(50),@MAC_ADR_NM) + '''','null') + ',                     
                          PORT_NBR                  =      '+ isnull('''' + convert(varchar(50),@PORT_NBR) + '''','null') + ',
                          VULN_INSTC_STS_CD                   =      ''' +CONVERT(VARCHAR,@VULN_INSTC_STS_CD)+''' ,
                          VULN_SEV_CD               =      '+ isnull('''' + convert(varchar(50),@VULN_SEV_CD) + '''','null') + ',
                           VULN_IMP_CD              =      '+ isnull('''' + convert(varchar(50),@VULN_IMP_CD) + '''','null') + ',
                           RISK_PRBL_CD                       =      '+ isnull('''' + convert(varchar(50),@RISK_PRBL_CD) + '''','null') + ',
                           RMDTN_CST_EFFRT_CD          =      '+ isnull('''' + convert(varchar(50),@RMDTN_CST_EFFRT_CD) + '''','null') + ',
                           VULN_CATGY_CD          =      '+ isnull('''' + convert(varchar(50),@VULN_CATGY_CD) + '''','null') + ',
                           CVE_ID                   =      '+ isnull('''' + convert(varchar(50),@CVE_ID) + '''','null') + ',
                           VULN_NM                           =      '+ isnull('''' + replace(convert(varchar(255),@VULN_NM),'''','''''') + '''','null') + ',
                           VULN_DESC                  =      '+ isnull('''' + replace(convert(varchar(max),@VULN_DESC),'''','''''') + '''','null') + ',
                           SRC_ADVS_TXT                       =      '+ isnull('''' + convert(varchar(max),@SRC_ADVS_TXT) + '''','null') + ',
                           VULN_BAS_SCOR               =      '+ isnull('''' + convert(varchar(50),@VULN_BAS_SCOR) + '''','null') + ',
                           VULN_IMP_SUB_SCOR           =      '+ isnull('''' + convert(varchar(50),@VULN_IMP_SUB_SCOR) + '''','null') + ',
                           VULN_EXPLT_SUB_SCOR         =         '+ isnull('''' + convert(varchar(50),@VULN_EXPLT_SUB_SCOR) + '''','null') + ',
                           VULN_TMPRL_SCOR          =      '+ isnull('''' + convert(varchar(50),@VULN_TMPRL_SCOR) + '''','null') + ',
                           VULN_ENV_SCOR               =      '+ isnull('''' + convert(varchar(50),@VULN_ENV_SCOR) + '''','null') + ',
                         VULN_VCTR_TXT                        =      '+ isnull('''' + convert(varchar(max),@VULN_VCTR_TXT) + '''','null') + ',
                            VULN_TECH_COMMT_TXT =   '+ isnull('''' + replace(convert(varchar(max),@VULN_TECH_COMMT_TXT),'''','''''') + '''','null') + ',
                           VULN_IMP_COMMT_TXT   =      '+ isnull('''' + replace(convert(varchar(max),@VULN_IMP_COMMT_TXT),'''','''''') + '''','null') + ',
                           RECOM_COMMT_TXT            =      '+ isnull('''' +replace(convert(varchar(max),@RECOM_COMMT_TXT),'''','''''') + '''','null') + ',
                           ROOT_CAUS_COMMT_TXT =      '+ isnull('''' + replace(convert(varchar(max),@ROOT_CAUS_COMMT_TXT),'''','''''') + '''','null') + ',   
                          UPDT_DT                   =     '+'GETDATE()'+',
                          UPDT_USER_ID                        =     '+convert(varchar(50),@USER_ID)+ ',
                          VULN_OVALL_SCOR           =      '+ isnull('''' + convert(varchar(50),@VULN_OVALL_SCOR) + '''','null') + ',
                           OWASP_TOP_10_KEY                   =      '+ isnull('''' + convert(varchar(50),@OWASP_TOP_10_KEY) + '''','null') + '

                          WHERE  CLNT_VULN_INSTC_KEY  =      '+ CONVERT(VARCHAR,@CLNT_VULN_INSTC_KEY) +''
                          EXECUTE (@Query)
                                           SELECT @@ROWCOUNT AS RETVAL
              END
                
 
END TRY

BEGIN CATCH

    DECLARE @ErrorNumber INT = ERROR_NUMBER();
    DECLARE @ErrorLine INT = ERROR_LINE();
    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE();
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY();
    DECLARE @ErrorState INT = ERROR_STATE();

    PRINT 'Actual error number: ' + CAST(@ErrorNumber AS VARCHAR(10));
    PRINT 'Actual line number: ' + CAST(@ErrorLine AS VARCHAR(10));

    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
  END CATCH
-- COMMIT TRANSACTION
END